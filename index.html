<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Novedades - Fullscreen Slider</title>

    <link rel="stylesheet" href="https://unpkg.com/blaze-slider@latest/dist/blaze.css" />
    <link rel="stylesheet" href="css/styles.css" />
  </head>

  <body>
    <div class="blaze-slider" id="news-slider">
      <div class="blaze-container">
        <div class="blaze-track" id="slides-container">
          <!-- ðŸ”¥ Las slides se agregan dinÃ¡micamente -->
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/blaze-slider@latest/dist/blaze-slider.min.js"></script>

    <script>
      const sliderEl = document.querySelector("#news-slider");
      const slidesContainer = document.querySelector("#slides-container");

      // ðŸš€ 1) Traemos los videos desde tu API
      async function loadSlides() {
        try {
          const res = await fetch("https://back-slider.onrender.com//traer"); 
          const videos = await res.json(); 

          console.log("ðŸŽ¥ Videos obtenidos:", videos);

          videos.forEach((video) => {
            const slide = document.createElement("div");
            slide.classList.add("slide");

            slide.innerHTML = `
              <video
                class="slide-media"
                playsinline
                muted
                preload="metadata"
                loop
                src="${video.url}"   <!-- URL del video en Cloudflare -->
              ></video>
              <div class="slide-overlay"></div>
              <div class="slide-content">
                <div class="icon"></div>
                <h2></h2>
                <p></p>
              </div>
            `;

            slidesContainer.appendChild(slide);
          });

          initSliderLogic();
        } catch (err) {
          console.error("âŒ Error cargando videos:", err);
        }
      }

      // ðŸš€ 2) LÃ³gica original: Blaze + Observer 
      function initSliderLogic() {
        const blaze = new BlazeSlider(sliderEl, {
          all: {
            loop: true,
            slidesToShow: 1,
            enableAutoplay: true,
            transitionDuration: 800,
            autoplayInterval: 7000,
          },
        });

        const slides = Array.from(document.querySelectorAll(".slide"));
        let currentVideo = null;

        const io = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              const slide = entry.target;
              const media = slide.querySelector(".slide-media");

              if (entry.intersectionRatio >= 0.6) {
                if (media && media.tagName.toLowerCase() === "video") {
                  blaze.stopAutoplay?.();

                  if (media.readyState >= 2) {
                    startVideo(media, blaze);
                  } else {
                    media.addEventListener(
                      "loadedmetadata",
                      () => startVideo(media, blaze),
                      { once: true }
                    );
                  }
                }
              } else {
                if (media && media.tagName.toLowerCase() === "video") {
                  media.pause();
                  media.currentTime = 0;
                  currentVideo = null;
                }
              }
            });
          },
          { threshold: [0.6] }
        );

        slides.forEach((s) => io.observe(s));

        function startVideo(media, blaze) {
          if (currentVideo === media) return;
          currentVideo = media;

          media.play().catch(() => {});

          media.onended = () => {
            currentVideo = null;
            blaze.next?.();
          };

          const checkEnd = setInterval(() => {
            if (!currentVideo) {
              clearInterval(checkEnd);
              return;
            }
            if (media.duration && media.currentTime >= media.duration - 0.3) {
              clearInterval(checkEnd);
              media.onended?.();
            }
          }, 300);
        }
      }

      // ðŸš€ Iniciar todo
      loadSlides();
    </script>
  </body>
</html>
